#! /usr/bin/env bash
# Claude Code Telegram notifications

# Load tokens
# shellcheck source=/dev/null
[ -f ~/.config/telegram-claude.env ] && source ~/.config/telegram-claude.env

TELEGRAM_API="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}"

send_message() {
    local text="$1"
    curl -s -X POST "${TELEGRAM_API}/sendMessage" \
        -d "chat_id=${TELEGRAM_CHAT_ID}" \
        -d "text=${text}" \
        -d "parse_mode=HTML" > /dev/null
}

get_project_name() {
    local cwd="$1"
    echo "$cwd" | rev | cut -d'/' -f1-2 | rev
}

# Read JSON from stdin (from Claude Code hooks)
input=$(cat)
hook_event=$(echo "$input" | jq -r '.hook_event_name // empty')
cwd=$(echo "$input" | jq -r '.cwd // empty')
project=$(get_project_name "$cwd")

case "$hook_event" in
    Notification)
        notification_type=$(echo "$input" | jq -r '.notification_type // empty')
        message=$(echo "$input" | jq -r '.message // empty')

        case "$notification_type" in
            idle_prompt)
                send_message "‚è≥ <b>[${project}]</b> Claude –æ–∂–∏–¥–∞–µ—Ç –≤–∞—à–µ–≥–æ –≤–≤–æ–¥–∞"
                ;;
            elicitation_dialog)
                send_message "‚ùì <b>[${project}]</b> Claude —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–æ–¥:
${message}"
                ;;
            *)
                send_message "üîî <b>[${project}]</b>
${message}"
                ;;
        esac
        ;;
    PermissionRequest)
        tool_name=$(echo "$input" | jq -r '.tool_name // empty')
        send_message "üîê <b>[${project}]</b> Claude –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: ${tool_name}"
        ;;
    Stop)
        send_message "‚úÖ <b>[${project}]</b> Claude Code –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É"
        ;;
    *)
        send_message "üìã <b>[${project}]</b> Event: ${hook_event}"
        ;;
esac
